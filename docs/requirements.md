# moi タスク運用システム 要件定義（Cursor投入用） v1.0

## 0. 背景と目的

moi（蒲郡）の運営を、かおり・まいちゃん・マキシムの3名で回している。現状は週1営業を基本にしつつ、将来的に週2営業を目指す。課題は主に以下。

1. 抜け漏れが起きやすい（投稿、取り置き、仕込み、開店準備、締めなど）
2. 引き継ぎが大変（情報がLINEや口頭に散る）
3. まいちゃんへ段階的に委譲したいが、型がない
4. マキシムはフランス語で、自分に割り当てられた作業だけを見て実行できる状態が必要
5. 運用ログを溜めて分析し、改善提案や自動改善（承認制）につなげたい

## 1. ゴール

1. 週次テンプレで定期タスクを自動生成し、抜け漏れを減らす
2. タスクはチェックリスト粒度まで分解し、誰が何をやるかを明確化する
3. マキシムは自分担当のみ表示、かおり・まいちゃんは全体管理可能
4. 日本語とフランス語の双方向翻訳（Gemini API）を組み込む
5. ログをイベントとして蓄積し、遅延・抜け・改善ポイントを可視化し、提案できる土台を作る

## 2. 利用者と権限

### 2.1 ユーザー

1. かおり（店長、管理者）
2. まいちゃん（共同管理者、タスク作成・管理）
3. マキシム（実行者、基本は指示された作業を実行）

### 2.2 権限と可視範囲

1. かおり・まいちゃん

* 全タスク・全チェック項目・全コメント閲覧可能
* タスク作成・編集、担当割り当て、期限変更、テンプレ編集、営業日例外編集が可能
* マキシムのタスクも閲覧・管理が可能

2. マキシム

* 自分に割り当てられた「作業」だけを表示

  * ここでの「作業」は、タスク本体ではなくチェック項目も含む
* 自分担当の作業について、進行状況更新、チェック完了、コメント投稿が可能
* 原則としてタスク作成やテンプレ編集は不可（将来スイッチで解放可能）

## 3. スコープ

### 3.1 MVPに含める

1. タスク登録・一覧・検索・フィルタ
2. タスク内チェックリスト（チェック項目に担当者を付けられる）
3. 週次テンプレの定義と自動生成（木曜営業基準、例外日で調整）
4. 投稿・取り置き運用をテンプレ化（チェックリストに落とす）
5. 翻訳（日本語→フランス語、フランス語→日本語）と用語集
6. アプリ内通知（最低限）
7. イベントログ収集（分析・改善の土台）

### 3.2 MVPではやらない（将来）

1. LINE公式アカウントへの自動投稿や自動返信（将来の拡張）
2. 受注管理の完全自動化（決済、在庫連動など）
3. 写真添付
4. 本格的な機械学習（まずはルールと統計＋Geminiで十分）

## 4. 用語定義

1. タスク: まとまりのある業務単位（例：開店準備、取り置き集計）
2. チェック項目: タスクを分解した最小行動（例：駐車場札を立てる）
3. 作業（Work Item）: マキシム画面に並ぶ単位。チェック項目が主になる想定
4. 週次テンプレ: 毎週の定型タスク群とそのチェック項目の設計図
5. 週インスタンス: 週次テンプレから生成された実体のタスク群
6. 営業日: デフォルト木曜。例外で変更可能
7. 投稿タスク: 営業告知、ラインナップ、取り置き案内、受付終了、open、sold out 等
8. 取り置き: 公式LINEで受付。営業日当日は受付しない。先着順で予定数に達するまで。受付完了返信が来たら完了

## 5. 業務ルール（運用に合わせて固定）

### 5.1 取り置きルール（要件として固定）

1. 営業日当日は製造・販売準備で返信不可のため、当日の取り置き受付はしない
2. 取り置きは先着順で、予定数に達するまで受付
3. 店側から「受付完了の返信」があった時点で受付完了
4. Instagram DMでは受け付けない。公式LINEで受付
5. 予定数に達した場合は、受付終了の告知を行う

### 5.2 投稿の種類（最低限）

1. 次回営業日の告知
2. ラインナップ告知
3. 取り置き案内（受付条件、受付完了の定義、受付窓口、締切条件）
4. 取り置き受付終了
5. open告知（当日）
6. sold out告知（必要時）
7. ONLINE SHOP案内（必要時）

## 6. 機能要件

### 6.1 ログインと端末

前提: 3人固定、iPhone中心、簡単優先

要件

1. 共通パスコードでログインできる
2. 初回ログイン時に「この端末の利用者」を選ぶ（かおり／まいちゃん／マキシム）
3. 端末には user_id が紐づき、以降は自動ログイン扱い
4. 管理者（かおり・まいちゃん）は端末の利用者切替ができる（紛失・機種変更対応）

将来拡張

* メールログイン等に移行可能な内部設計（user_id を中核にする）

### 6.2 タスク

タスク必須項目

1. タイトル
2. 詳細（自由記述）
3. 期限日時（必須、日付＋時間）
4. 優先度（高・中・低）
5. ステータス（未着手／進行中／完了／保留）
6. 担当者（基本はタスク担当。チェック項目担当が上位概念として優先される）
7. 週キー（例：2026-W03）
8. 作成者、作成日時、更新日時

タスク任意項目

1. タグ（投稿、取り置き、仕込み、焼き、開店、締め など）
2. 関連営業日（例外日を含む実日付）

操作

1. 作成、編集、複製、削除（削除は管理者のみ）
2. 一覧表示、フィルタ（週、期限、担当、タグ、未完了）
3. 検索（タイトル・詳細）
4. 履歴（誰がいつ編集したか）

### 6.3 チェックリスト（最重要）

チェック項目必須項目

1. 本文
2. 担当者（かおり／まいちゃん／マキシム）
3. 状態（未完了／完了）
4. 完了者、完了日時

チェック項目任意項目

1. 期限日時（タスクと別に持てる。デフォルトはタスク期限）
2. 並び順

表示要件

1. かおり・まいちゃんはタスク単位で全チェック項目を見て管理できる
2. マキシムは「自分担当のチェック項目」だけを一覧化して見られる
3. マキシムがチェック完了すると、かおり・まいちゃん側にも即時反映される

### 6.4 コメント

要件

1. タスク単位でスレッド形式コメント
2. コメントも翻訳対象（後述）
3. コメントには投稿者、投稿日時を保持

### 6.5 週次テンプレと自動生成

目的: 毎週の業務を自動で立ち上げ、抜け漏れを防ぐ

テンプレ構造

1. 週次テンプレ（複数のテンプレタスクを持つ）
2. テンプレタスクはチェック項目テンプレを持つ
3. 各テンプレタスクには「期限ルール」を持つ

* 基準日: 営業日（デフォルト木曜）
* 相対オフセット: 例「営業日-4日 20:00」
* 例外日変更時は自動で再計算

生成タイミング

1. 自動生成: 毎週 日曜 18:00 に次週分を生成
2. 手動生成: かおり・まいちゃんが「今週生成」ボタンで生成できる
3. 冪等性: 同じ週キーに対して二重生成しない

* 既存がある場合は「不足分だけ追加」が基本
* 既に編集された実タスクは上書きしない

営業日例外

1. デフォルトは木曜
2. 例外週のみ「木曜→別日」に変更できる
3. 変更後、未完了のタスク期限は自動再計算（ただし手動変更が入っている場合は保護ルールを設ける）

### 6.6 投稿・取り置きテンプレ（MVPで必須）

目的: 投稿と取り置き運用を型化し、抜け漏れを防ぐ

投稿タスク（テンプレ）

* 投稿種別: 営業告知、ラインナップ、取り置き案内、受付終了、open、sold out、オンライン案内
* チェック項目例

1. 文面作成
2. 日時の確認
3. 取り置き条件の確認（必要時）
4. 投稿実行
5. 投稿後の反応チェック（任意）

取り置き運用タスク（テンプレ）

* チェック項目例

1. 取り置き案内を投稿（公式LINE誘導、DM不可、営業日当日不可、先着、受付完了返信が完了条件）
2. 取り置き受付の受付処理（随時）
3. 受付完了返信を送る
4. 集計を更新する
5. 予定数に達したら受付終了を投稿する
6. 製造計画に反映する

補足: 本格的な受注管理は将来でも良いが、MVPで「簡易集計フォーム」を用意すると効果が高い

* 顧客名
* 商品名と個数（複数行）
* ステータス（未返信／受付完了／不可／キャンセル）
* 合計個数
* メモ

### 6.7 翻訳（Gemini API）

言語設定

1. かおり、まいちゃん: 日本語表示がデフォルト
2. マキシム: フランス語表示がデフォルト
3. 将来: かおり・まいちゃんも表示切替可能（MVPでも入れて良い）

翻訳対象

1. タスク（タイトル、詳細）
2. チェック項目本文
3. コメント本文

双方向

1. 日本語入力 → フランス語を生成して保存
2. フランス語入力（マキシムのコメント等） → 日本語を生成して保存

翻訳タイミング

1. 作成・更新時に翻訳して保存（表示時に毎回APIを呼ばない）
2. 原文が更新されたら再翻訳フラグを立てる
3. 翻訳失敗時はリトライできる

用語集

1. 用語集を管理画面で編集可能
2. 翻訳プロンプトに用語集を必ず含める
3. 例（初期）

* 仕込み、焼き、発注、買い込み、取り置き、レジ締め、開店準備、締め、受付完了、受付終了

### 6.8 通知

MVP

1. アプリ内通知

* 自分担当の作業が追加された
* 期限が近い（例: 24時間前、2時間前）
* コメントが付いた（自分担当のタスク）

将来

* LINE通知（Messaging API等）

### 6.9 ログ収集、分析、改善、リコメンド

方針: まずはイベントログを確実に溜める。改善は提案して承認で反映。

イベントログ（最低限）

1. task_created, task_updated, task_deleted
2. checklist_created, checklist_updated, checklist_checked, checklist_unchecked
3. status_changed
4. comment_created
5. template_generated, template_updated
6. schedule_exception_changed
7. translation_requested, translation_succeeded, translation_failed
8. notification_sent, notification_opened（可能なら）

分析（MVPは閲覧可能な簡易ダッシュボードで良い）

1. 期限超過が多いタスク、チェック項目
2. よく抜ける投稿（受付終了告知など）
3. 生成されたが使われていないチェック項目（常に未実行など）
4. マキシム作業の集中（当日直前に集中していないか）

リコメンド（フェーズ2以降、MVPでも雛形は作る）

* 例: 毎回追加されるチェック項目をテンプレに追加提案
* 例: いつも遅れる投稿タスクの期限を前倒し提案
* 例: マキシムに割り当てた方が早い作業候補の提案

自動改善のルール

1. システムがテンプレ変更を勝手に適用しない
2. 提案は「承認待ち」として表示し、かおり・まいちゃんが承認したら反映

## 7. 非機能要件

1. iPhoneで快適に動く（PWA推奨）
2. オフラインは必須ではないが、通信不安定時でも最低限閲覧は崩れにくい
3. 翻訳API失敗時でも日本語原文は必ず見える
4. 操作ログと編集履歴は最低限保持する（原因追跡のため）
5. データは少人数前提でも、将来メンバー追加できる構造にする

## 8. データモデル（概念設計）

必須エンティティ

1. users

* id, name, role（admin, coadmin, worker）, default_language（ja, fr）

2. devices（端末ログイン用）

* id, device_identifier, user_id, last_seen_at

3. weeks（週インスタンス）

* id, week_key, business_date_default（木曜実日付）, business_date_actual（例外後日付）, created_at

4. tasks

* id, week_id, title_ja, title_fr, body_ja, body_fr, due_at, priority, status, tag, created_by, updated_by

5. checklist_items

* id, task_id, text_ja, text_fr, assignee_user_id, due_at, is_done, done_by, done_at, sort_order

6. comments

* id, task_id, author_user_id, body_ja, body_fr, created_at

7. templates（週次テンプレ）

* id, name, is_active, version, updated_at

8. template_tasks

* id, template_id, title_ja, body_ja, relative_due_rule（例: -4 days 20:00）, tag, sort_order

9. template_checklist_items

* id, template_task_id, text_ja, default_assignee_role_or_user, sort_order

10. glossary_terms

* id, ja_term, fr_term, note

11. event_logs

* id, event_type, user_id, task_id, checklist_item_id, payload_json, created_at

12. recommendations（提案）

* id, type, payload_json, status（proposed, approved, rejected）, created_at, decided_by

翻訳管理

* 翻訳済み時刻 translated_at、再翻訳必要フラグ needs_retranslate を tasks/checklist/comments に持たせるか、別テーブルで管理

## 9. 画面要件（UI詳細はGemini 3Proに委譲）

Gemini 3Proに渡す前提でも、画面の入出力と必須要素は固定する。

### 9.1 マキシム用（自分担当のみ）

1. 自分の作業一覧

* 自分担当のチェック項目をカード化
* 期限順、今日、明日、今週フィルタ
* 1タップで完了、コメント

2. 作業詳細

* 元のタスク名（参照のみ）
* チェック項目本文、期限、状態
* コメント欄（仏語で入力可）

### 9.2 かおり・まいちゃん用（管理）

1. 今週の全体

* 週次インスタンスのタスク一覧
* 未完了_toggle
* 担当別フィルタ、タグフィルタ

2. タスク詳細

* タスク編集
* チェック項目編集、担当割当
* コメント
* 翻訳状態（失敗時再実行）

3. マキシム管理ビュー

* マキシム担当作業だけ抽出して確認できる

4. 週次テンプレ管理

* テンプレタスクと期限ルール編集
* チェック項目テンプレ編集
* バージョン管理（最低限、更新履歴）

5. 営業日例外編集

* 対象週の営業日を変更
* 変更後の期限再計算結果を確認

6. ダッシュボード（簡易）

* 期限超過
* 抜けがちな投稿
* 提案一覧（承認ボタン）

## 10. 初期テンプレ（週1営業向け、木曜基準の例）

相対期限は仮。管理画面で調整できる前提で、初期値を置く。

1. 投稿: 営業告知（営業日-7日 18:00）

* 文面作成
* 日時確認
* 投稿

2. 投稿: 取り置き案内（営業日-4日 20:00）

* 取り置きルール確認（当日不可、先着、公式LINE、DM不可、受付完了返信）
* 投稿

3. 取り置き運用と集計（営業日-3日 10:00）

* 受付処理（随時）
* 受付完了返信
* 集計更新
* 予定数到達なら受付終了投稿

4. 製造計画（営業日前日 21:00）

* 合計数決定（後日詳細入力）
* 内訳決定（後日詳細入力）
* 仕込み割り振り

5. 仕込み（営業日 当日 09:00）

* 工程チェック項目（後日詳細入力、マキシム担当をここに割当可能）

6. 焼き（営業日 当日 10:30）

* 工程チェック項目（後日詳細入力、マキシム担当をここに割当可能）

7. 開店準備（営業日 当日 13:00）

* 駐車場札を立てる（マキシム）
* 駐車場ブロック移動（マキシム）
* レジ準備（まいちゃん）
* 釣銭確認（かおり）
* 表示物確認（まいちゃん）

8. 閉店作業（営業日 当日 17:00）

* 片付け（マキシム含む）
* 清掃（マキシム含む）
* 締め（かおり・まいちゃん）

## 11. フェーズ計画（ログ活用の進め方）

フェーズ1（MVP）

* 週次テンプレ自動生成
* チェック項目担当で運用
* 翻訳と用語集
* イベントログ収集
* 簡易ダッシュボード（遅延・超過）

フェーズ2（改善提案）

* ログから提案を生成（ルール＋Gemini）
* 提案の承認フロー
* 承認後にテンプレへ反映

フェーズ3（半自動最適化）

* 期限の前倒し提案
* 追加されがちなチェック項目の自動候補化
* 担当割当の提案

## 12. 受け入れ条件（Acceptance Criteria）

1. 日曜18:00に翌週のタスクが自動生成される（週キーで二重生成しない）
2. 例外で営業日を変更すると、未完了タスクの期限が営業日基準で再計算される
3. タスクにチェック項目を追加し、チェック項目に担当を設定できる
4. マキシム端末では、自分担当の作業だけが一覧表示される
5. かおり・まいちゃんはマキシム作業も含め全体を閲覧・編集できる
6. 日本語で入力したタスク・チェック・コメントはフランス語が保存され、マキシムはフランス語で見える
7. マキシムがフランス語でコメントすると、日本語が保存され、かおり・まいちゃんは日本語で見える
8. 主要イベントが event_logs に記録される
9. 翻訳失敗時に再実行でき、原文は必ず残る
10. 投稿・取り置き運用テンプレが存在し、最低限のチェック項目で運用できる

## 13. 未確定事項（仮置きと可変パラメータ）

質問を増やさずに進めるため、以下は設定で後から変えられる設計にする。

1. 取り置きの締切条件

* デフォルト: 予定数到達で締切
* オプション: 時刻締切も併用できる

2. 予定数の決め方

* デフォルト: 週ごとに手入力フィールドを用意（管理者が入力）
* 将来: 過去ログから推奨予定数を提案

3. 製造計画の詳細

* MVPはテキスト入力で良い
* 将来は商品別個数のフォーム入力に拡張

---

## Cursorへの実装指示（短縮版）

1. PWA対応のNext.jsを前提に、SupabaseでDBと認証相当（共通パスコード＋devices）を実装
2. スキーマは「データモデル」章に準拠
3. 週次テンプレ、生成ジョブ（cron相当）、手動生成を実装
4. 作業の最小単位は checklist_items とし、マキシム一覧は checklist_items の assignee_user_id で抽出
5. 翻訳はGemini APIで「保存型」実装（作成・更新時）
6. event_logs を全主要操作で記録
7. UIの見た目とレイアウト設計はGemini 3Proに委譲。ただし画面要件の入出力は遵守

必要なら、この要件定義をそのまま「Gemini 3Pro向けUIプロンプト」に変換した文章も作れます（画面ごとの必須要素とコンポーネント要件だけを抜き出したもの）。
